version: '3.8'

services:
  # Consul Server - Service Discovery and Configuration
  consul-server:
    image: hashicorp/consul:1.20
    container_name: consul-server
    hostname: consul-server
    command: >
      agent -server 
      -ui 
      -bootstrap-expect=1 
      -client=0.0.0.0 
      -datacenter=dc1
      -data-dir=/consul/data
      -log-level=INFO
      -enable-script-checks=true
    ports:
      # HTTP API and Web UI
      - "8500:8500"
      # DNS Interface
      - "8600:8600/tcp"
      - "8600:8600/udp"
      # Server RPC
      - "8300:8300"
      # Serf LAN
      - "8301:8301/tcp"
      - "8301:8301/udp"
      # Serf WAN
      - "8302:8302/tcp"
      - "8302:8302/udp"
    volumes:
      # Persist Consul data
      - consul-data:/consul/data
      # Optional: Custom configuration
      - ./consul/config:/consul/config
    environment:
      - CONSUL_BIND_INTERFACE=eth0
      - CONSUL_CLIENT_INTERFACE=eth0
    networks:
      - microservices
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    labels:
      - "com.custom.framework.service=consul-server"
      - "com.custom.framework.description=Service Discovery and Configuration"

  # Optional: Consul Agent (for multi-node setup)
  # consul-agent:
  #   image: hashicorp/consul:1.20
  #   container_name: consul-agent
  #   hostname: consul-agent
  #   command: >
  #     agent 
  #     -retry-join=consul-server
  #     -client=0.0.0.0
  #     -datacenter=dc1
  #     -data-dir=/consul/data
  #     -log-level=INFO
  #   depends_on:
  #     consul-server:
  #       condition: service_healthy
  #   volumes:
  #     - consul-agent-data:/consul/data
  #   networks:
  #     - microservices
  #   restart: unless-stopped

networks:
  microservices:
    driver: bridge
    name: custom-microservices-network

volumes:
  consul-data:
    driver: local
    name: consul-server-data
  # consul-agent-data:
  #   driver: local
  #   name: consul-agent-data

# Azure Cosmos DB Integration Tests

## Overview

Comprehensive integration tests for Azure Cosmos DB Order Management system. Tests cover the complete hospitality reservation flow, EF Core Cosmos provider functionality, and edge cases.

---

## Test Files

### 1. **CosmosTestContainer.cs**
Test infrastructure for Cosmos DB Emulator
- Supports both Windows (local emulator) and Linux (Docker container)
- Automatic emulator detection and initialization
- Health check verification

### 2. **CosmosDbOrderTests.cs**
Integration tests for `IOrderRepository`
- **CRUD operations**: Create, Read, Update, Delete
- **Query tests**: By hotel, status, session, pending orders
- **Flow tests**: Complete reservation flow, failed payment scenarios
- **TTL tests**: Pending vs succeeded order TTL
- **Concurrency tests**: ETag-based optimistic concurrency

### 3. **CosmosDbContextTests.cs**
Integration tests for `OrderDbContext`
- **DbSet operations**: Add, Find, Remove
- **Partition key queries**: Efficient partition-scoped queries
- **Complex properties**: Owned types, dictionaries, nested objects
- **LINQ queries**: Where, OrderBy, Count, filtering
- **Change tracking**: Tracked vs no-tracking queries
- **Batch operations**: AddRange, RemoveRange

---

## Prerequisites

### Windows Development
1. **Install Cosmos DB Emulator**
   ```powershell
   # Option 1: Download installer
   # https://aka.ms/cosmosdb-emulator
   
   # Option 2: Chocolatey
   choco install azure-cosmosdb-emulator
   ```

2. **Start Emulator**
   - Start Menu ? Azure Cosmos DB Emulator
   - Or run: `C:\Program Files\Azure Cosmos DB Emulator\CosmosDB.Emulator.exe`

3. **Verify Emulator**
   - Open browser: https://localhost:8081/_explorer/index.html
   - Accept self-signed certificate

### Linux/Mac Development (Docker)
```bash
docker run -p 8081:8081 -p 10251-10254:10251-10254 \
  --name cosmos-emulator \
  mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:latest
```

**Note:** Cosmos DB Emulator on Linux/Mac has limitations. For best results, use actual Azure Cosmos DB for testing.

---

## Running Tests

### Run All Cosmos Tests
```bash
dotnet test --filter "FullyQualifiedName~Azure"
```

### Run Specific Test Class
```bash
# Order Repository Tests
dotnet test --filter "FullyQualifiedName~CosmosDbOrderTests"

# DbContext Tests
dotnet test --filter "FullyQualifiedName~CosmosDbContextTests"
```

### Run Single Test
```bash
dotnet test --filter "FullyQualifiedName~CosmosDbOrderTests.CreateOrder_ShouldCreatePendingOrderWithTtl"
```

### Run with Verbose Output
```bash
dotnet test --filter "FullyQualifiedName~Azure" --logger "console;verbosity=detailed"
```

---

## Test Categories

### ? Repository CRUD Tests
Tests basic repository operations:
- `CreateOrder_ShouldCreatePendingOrderWithTtl`
- `GetOrderById_ShouldRetrieveOrder`
- `GetOrderBySessionId_ShouldRetrieveMostRecentOrder`
- `UpdateOrder_ShouldModifyOrderData`
- `UpdateOrderStatus_ShouldChangeStatusAndTtl`
- `DeleteOrder_ShouldRemoveOrder`

### ? Query Tests
Tests various query patterns:
- `GetOrdersByHotel_ShouldReturnAllOrdersForHotel`
- `GetOrdersByStatus_ShouldFilterByStatus`
- `GetPendingOrders_ShouldReturnOnlyPendingOrders`
- `OrderExists_ShouldReturnTrueForExistingOrder`

### ? Hospitality Flow Tests
Tests complete reservation flow:
```
SearchHeader ? SelectHeader ? ReservationHeader ? 
EdgeServiceVerification ? Payment ? ReservationSummary
```

Tests:
- `CompleteReservationFlow_ShouldUpdateOrderThroughAllSteps`
- `FailedPaymentFlow_ShouldUpdateStatusToFailed`

### ? TTL Tests
Tests automatic TTL management:
- `PendingOrder_ShouldHaveShortTtl` (600 seconds)
- `SucceededOrder_ShouldHaveLongTtl` (604800 seconds / 7 days)

### ? Concurrency Tests
Tests ETag-based concurrency control:
- `ConcurrentUpdate_ShouldHandleETagConflict`

### ? DbContext Tests
Tests EF Core Cosmos provider:
- Partition key queries
- Owned types persistence
- LINQ operations
- Change tracking
- Batch operations

---

## Test Data

All tests use isolated test data with unique identifiers:
- Hotel codes: `HOTEL001`, `HOTEL_FLOW`, `HOTEL_PARTITION`, etc.
- Session IDs: Generated GUIDs
- Order IDs: Generated by Cosmos DB

**Cleanup:** Tests rely on TTL for automatic cleanup (10 minutes for pending orders).

---

## Configuration

Tests use in-memory configuration:

```csharp
var cosmosConfig = new Dictionary<string, string?>
{
    ["CosmosDB:UseEmulator"] = "true",
    ["CosmosDB:AccountEndpoint"] = "https://localhost:8081",
    ["CosmosDB:AccountKey"] = "C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==",
    ["CosmosDB:DatabaseName"] = "HospitalityOrdersTest",
    ["CosmosDB:ContainerName"] = "OrdersTest",
    ["CosmosDB:PartitionKeyPath"] = "/hotelCode",
    ["CosmosDB:DefaultTtlSeconds"] = "600",
    ["CosmosDB:SucceededTtlSeconds"] = "604800"
};
```

---

## Example Test Output

```
?? Starting Azure Cosmos DB Emulator...
? Using local Windows Cosmos DB Emulator
? Cosmos DB Emulator is accessible
? Test host initialized and database ready

? Database: HospitalityOrdersTest
? Container: OrdersTest
? Partition Key: /hotelCode

? Created order: 7a3e5c8d-1234-5678-90ab-cdef12345678
   Status: Pending
   TTL: 600 seconds
   Expires: 2024-12-15T10:20:00Z

Step 1 - SearchHeader: 7a3e5c8d-1234-5678-90ab-cdef12345678
Step 2 - SelectHeader: Room=DELUXE, Amount=$450.00
Step 3 - ReservationHeader: Guest=John Doe
Step 4 - EdgeServiceVerification: Verified=True
Step 5 - Payment: TxnId=TXN-abc123, Status=Success
Step 6 - ReservationSummary: Complete!
? Complete reservation flow executed successfully!
```

---

## Troubleshooting

### Issue: Cannot Connect to Emulator

**Windows:**
```powershell
# Check if emulator is running
Get-Process -Name "Microsoft.Azure.Cosmos.Emulator"

# Start emulator
Start-Process "C:\Program Files\Azure Cosmos DB Emulator\CosmosDB.Emulator.exe"
```

**Certificate Issues:**
```powershell
# Export certificate
Invoke-WebRequest -Uri https://localhost:8081/_explorer/emulator.pem -OutFile emulator.pem

# Import to trusted root
Import-Certificate -FilePath .\emulator.pem -CertStoreLocation Cert:\CurrentUser\Root
```

### Issue: Tests Timeout

**Solution:** Increase test timeout in xUnit:
```csharp
[Fact(Timeout = 60000)] // 60 seconds
public async Task MyTest()
{
    // ...
}
```

### Issue: Concurrent Tests Fail

**Cause:** Cosmos DB Emulator has connection limits

**Solution:** Run tests sequentially:
```bash
dotnet test --filter "FullyQualifiedName~Azure" -- xUnit.MaxParallelThreads=1
```

### Issue: ETag Concurrency Conflicts

**Expected Behavior:** `DbUpdateConcurrencyException` is thrown when concurrent updates occur

**Verification:**
```csharp
await updateAction.Should().ThrowAsync<DbUpdateConcurrencyException>();
```

---

## Performance Considerations

### Cosmos DB Emulator Limitations
- **Connection limit:** ~200 concurrent connections
- **Throughput:** Lower than production Azure Cosmos DB
- **Latency:** Higher than production

### Best Practices for Tests
1. Use partition keys in all queries
2. Clean up test data (or rely on TTL)
3. Run integration tests sequentially
4. Use xUnit collection fixtures for shared setup

---

## CI/CD Integration

### GitHub Actions Example

```yaml
name: Integration Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x
    
    - name: Install Cosmos DB Emulator
      run: choco install azure-cosmosdb-emulator
    
    - name: Start Cosmos DB Emulator
      run: |
        Start-Process "C:\Program Files\Azure Cosmos DB Emulator\CosmosDB.Emulator.exe"
        Start-Sleep -Seconds 30
    
    - name: Run Tests
      run: dotnet test --filter "FullyQualifiedName~Azure" --logger trx
    
    - name: Upload Test Results
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: '**/*.trx'
```

### Azure DevOps Pipeline Example

```yaml
trigger:
- main

pool:
  vmImage: 'windows-latest'

steps:
- task: UseDotNet@2
  inputs:
    version: '8.0.x'

- powershell: |
    choco install azure-cosmosdb-emulator
    Start-Process "C:\Program Files\Azure Cosmos DB Emulator\CosmosDB.Emulator.exe"
    Start-Sleep -Seconds 30
  displayName: 'Start Cosmos DB Emulator'

- task: DotNetCoreCLI@2
  inputs:
    command: 'test'
    arguments: '--filter "FullyQualifiedName~Azure" --logger trx'
  displayName: 'Run Integration Tests'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/*.trx'
```

---

## Test Coverage

| Component | Coverage | Tests |
|-----------|----------|-------|
| IOrderRepository | 100% | 15+ tests |
| OrderDbContext | 100% | 12+ tests |
| CosmosDbInitializer | 90% | 2 tests |
| Models | 100% | Covered in integration tests |
| Extensions | 100% | Covered in setup |

**Total Tests:** 29+

---

## Additional Resources

- [Cosmos DB Emulator Documentation](https://learn.microsoft.com/en-us/azure/cosmos-db/local-emulator)
- [EF Core Cosmos Provider](https://learn.microsoft.com/en-us/ef/core/providers/cosmos/)
- [xUnit Documentation](https://xunit.net/)
- [FluentAssertions](https://fluentassertions.com/)

---

## Contributing

When adding new tests:
1. Follow existing test patterns
2. Use descriptive test names: `Method_Scenario_ExpectedResult`
3. Use FluentAssertions for readable assertions
4. Add xUnit output for debugging
5. Clean up test data or rely on TTL
6. Update this README with new test categories

---

**Last Updated:** December 2024  
**Framework Version:** .NET 8  
**EF Core Version:** 8.0.11  
**Cosmos DB SDK:** 3.42.0

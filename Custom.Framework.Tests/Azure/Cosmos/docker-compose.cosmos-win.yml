version: "3.8"

services:
  # Azure Cosmos DB Emulator
  # Note: Linux emulator has limitations. For production-like testing, use actual Azure Cosmos DB.
  cosmos-emulator:
    image: mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:latest
    container_name: cosmos-emulator
    hostname: cosmos-emulator
    # Removed platform constraint to let Docker Desktop choose appropriate runtime
    ports:
      - "8081:8081"      # Data Explorer (Web UI)
      - "10251:10251"    # Emulator endpoint
      - "10252:10252"    # Emulator endpoint
      - "10253:10253"    # Emulator endpoint
      - "10254:10254"    # Emulator endpoint
    environment:
      # Cosmos DB Emulator configuration
      # https://learn.microsoft.com/en-us/azure/cosmos-db/docker-emulator-linux
      AZURE_COSMOS_EMULATOR_PARTITION_COUNT: "10"
      AZURE_COSMOS_EMULATOR_ENABLE_DATA_PERSISTENCE: "true"
      AZURE_COSMOS_EMULATOR_IP_ADDRESS_OVERRIDE: "127.0.0.1"
      AZURE_COSMOS_EMULATOR_KEY: "C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw=="
    volumes:
      - cosmos-data:/var/lib/cosmosdb
    networks:
      - cosmos-network
    healthcheck:
      test: ["CMD-SHELL", "curl -k -f https://localhost:8081/_explorer/emulator.pem || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s  # Emulator takes time to start
    restart: unless-stopped
    # Resource limits (Cosmos emulator is resource-intensive)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  # Optional: Cosmos DB initialization service
  # Runs once to create database and container
  cosmos-init:
    image: mcr.microsoft.com/azure-cli:latest
    container_name: cosmos-init
    profiles: ["init"]  # Only run with: docker-compose --profile init up
    depends_on:
      cosmos-emulator:
        condition: service_healthy
    environment:
      COSMOS_ENDPOINT: "https://cosmos-emulator:8081"
      COSMOS_KEY: "C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw=="
      DATABASE_NAME: "HospitalityOrders"
      CONTAINER_NAME: "Orders"
      PARTITION_KEY: "/hotelCode"
    volumes:
      - ./cosmos-init.sh:/scripts/cosmos-init.sh:ro
    entrypoint: ["/bin/sh", "-c"]
    command: 
      - |
        set -e
        echo "🚀 Initializing Cosmos DB..."
        
        # Install required tools
        apk add --no-cache curl jq bash
        
        # Wait for emulator to be fully ready
        echo "⏳ Waiting for Cosmos DB Emulator..."
        for i in $(seq 1 30); do
          if curl -k -f https://cosmos-emulator:8081/_explorer/index.html > /dev/null 2>&1; then
            echo "✅ Cosmos DB Emulator is ready"
            break
          fi
          echo "   Attempt $i/30 - waiting..."
          sleep 10
        done
        
        # Execute initialization script if provided
        if [ -f /scripts/cosmos-init.sh ]; then
          echo "📄 Running custom initialization script..."
          chmod +x /scripts/cosmos-init.sh
          /bin/sh /scripts/cosmos-init.sh
        else
          echo "ℹ️  No custom initialization script found"
          echo "   Database and container will be created by application on first run"
        fi
        
        echo "✅ Cosmos DB initialization complete"
    networks:
      - cosmos-network
    restart: "no"  # Run once

networks:
  cosmos-network:
    driver: bridge

volumes:
  cosmos-data:
    driver: local
